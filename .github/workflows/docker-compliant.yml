name: Build and Push Docker Image - Compliant

on:
  schedule:
    - cron: "33 13-22 * * 1-5"
  workflow_dispatch: {}

env:
  OCTOPUS_URL: https://demo.octopus.app
  OCTOPUS_SERVICE_ACCOUNT: 4d50c8ac-1515-4351-96a7-4a82d55d55ff
  OCTOPUS_SPACE: "re:Invent"
  DOCKER_HUB_REPOSITORY: octopussolutionsengineering/ghu-account-registry
  SBOM_PACKAGE: ghu-account-registry.sbom

jobs:
  configure:
    runs-on: ubuntu-latest
    name: Pipeline Init and Versioning
    outputs:
      version: ${{ steps.version-generator.outputs.version }}
    steps:
      - name: Set version number
        id: version-generator
        run: echo "version=$(date +'%y.%m.%d%H%M%S')" >> $GITHUB_OUTPUT

  scan:
    # Runs in parallel with Build
    runs-on: ubuntu-latest
    name: Scan Repo (SAST)
    needs: [configure] 
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner on repo
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: "fs"
          ignore-unfixed: true
          exit-code: "1"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "MEDIUM,HIGH,CRITICAL"
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

  build:
    name: Build & Push Image
    needs: [configure]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      app_hash: ${{ steps.push-docker-images.outputs.DEMO_APP_DOCKER_SHA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build API container
        working-directory: ./API/
        run: |
          docker build -f "Dockerfile" \
            --tag $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }} .

      # 1. TRIVY VULN SCAN (Blocks if Critical)
      - name: Run Trivy vulnerability scanner on docker container
        uses: aquasecurity/trivy-action@0.32.0
        with:
          image-ref: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ needs.configure.outputs.version }}
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      # 2. PUSH IMAGE
      - name: Push Docker images
        id: push-docker-images
        working-directory: ./API
        run: |
          docker push $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }}
          dockerSha=$(docker manifest inspect $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }} -v | jq -r '.Descriptor.digest')
          echo "DEMO_APP_DOCKER_SHA=$dockerSha" >> $GITHUB_OUTPUT

  sbom:
    name: Publish SBOM
    # NEW STAGE: Runs after Build, before Release
    needs: [configure, build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      sbom_hash: ${{ steps.determine_sbom_hash.outputs.SBOM_HASH }}
    steps:
      - name: Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
          
      - name: Run Trivy in for SPDX mode for Octopus Deploy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'image'
          format: 'spdx-json'
          output: 'dependency-results.sbom.json'
          image-ref: '${{ env.DOCKER_HUB_REPOSITORY }}:${{ needs.configure.outputs.version }}'

      - name: Package SBOM
        uses: OctopusDeploy/create-zip-package-action@v3
        with:
          package_id: "${{ env.SBOM_PACKAGE }}"
          version: "${{ needs.configure.outputs.version }}"
          base_path: "./"
          files: "dependency-results.sbom.json"
          output_folder: packaged

      - name: Calculate SBOM Hash
        id: determine_sbom_hash
        shell: pwsh
        run: |
          $packageHash = Get-FileHash -path "packaged/${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip" -Algorithm SHA256
          $hashToSave = $packageHash.Hash 
          "SBOM_HASH=$hashToSave" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - uses: OctopusDeploy/push-build-information-action@v3
        name: Push build information üêô
        with:
          version: ${{ needs.configure.outputs.version }}
          packages: |
            ${{ env.DOCKER_HUB_REPOSITORY }}
            ${{ env.SBOM_PACKAGE }}

      - name: Push SBOM package to Octopus üêô
        uses: OctopusDeploy/push-package-action@v3
        with:
          packages: |
            packaged/${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip

  create-gh-release:
    name: Publish GitHub Release
    # Now waits for 'scan' (SAST) AND 'sbom' (which implies Build is done)
    needs: [configure, scan, sbom]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v1
      - name: Create Release for GitHub
        uses: ncipollo/release-action@v1
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: "${{ needs.configure.outputs.version }}"
          name: Release ${{ needs.configure.outputs.version }}
          body: |
            Automatic Release creation by GitHub Action
            Commit Message: ${{ github.event.head_commit.message }}
          draft: false

  create_attestations:
    name: Sign/Generate Attestation (SLSA)
    # Waits for Release (and implicitly SBOM/Build)
    needs: [configure, create-gh-release, build, sbom]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
    steps:
      - name: Create the subject checksum file for provenance
        shell: pwsh
        run: |
          # sbom_hash comes from 'sbom' job, app_hash comes from 'build' job
          $cleanedSbomSha = $("${{ needs.sbom.outputs.sbom_hash }}" -replace "sha256:", "").Trim()
          $cleanedImageSha = $("${{ needs.build.outputs.app_hash }}" -replace "sha256:", "").Trim()

          $imageSubject = "${{ env.DOCKER_HUB_REPOSITORY }}:${{ needs.configure.outputs.version }}".Trim()
          $sbomSubject = "${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip".Trim()

          $subjectText = @"
          $cleanedImageSha  $imageSubject
          $cleanedSbomSha  $sbomSubject
          "@

          New-Item -Path . -Name "subject.checksums.txt" -ItemType "File" -Value $subjectText
      - name: Generate attestation from provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-checksums: subject.checksums.txt

  octopus_handoff:
    name: Deploy from Octopus Deploy üêô
    needs: [configure, create_attestations]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Login to Octopus Deploy üêô
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - name: Create and Deploy Release to Dev üêô
        uses: OctopusDeploy/create-release-action@v3
        with:
          project: 'ghu-account-registry'
          package_version: '${{ needs.configure.outputs.version }}'
          deploy_to: 'Development'
          build_information: |
            [GitHub Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
